<?xml version="1.0" encoding="UTF-8"?>
<flow xmlns="http://www.springframework.org/schema/webflow"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://www.springframework.org/schema/webflow http://www.springframework.org/schema/webflow/spring-webflow.xsd">
                          
    <!-- 绑定credential 可以在此直接绑定也可在代码中进行绑定 by wcc 20190703 -->                     
	<var name="credential" class="org.suresec.authentication.UsernamePasswordKeyPINCredential"/>
    <action-state id="initializeLoginForm">
        <evaluate expression="initializeLoginAction" />
        <transition on="success" to="viewLoginForm"/>
    </action-state>

    <view-state id="viewLoginForm" view="casLoginView" model="credential">
        <binder>
            <binding property="username" required="true"/>
            <binding property="password" required="true"/>
            <binding property="verificationCode" />
            <!-- add by wlw ,add key pin, 2017.6.27 -->
            <binding property="CertDN" />
			<binding property="signvalue" />			
			<binding property="sInData" />
			<binding property="cert_flag" />
			<binding property="submitMode"/>
        </binder>
        <transition on="submit" bind="true" validate="true" to="submitMode" history="invalidate"/>
    </view-state>
    
    <!-- 判断登录类型 wcc 20190702 move here -->
    <action-state id="submitMode">
    	<evaluate expression="authenticationViaFormKeyPinAction.submitMode(flowRequestContext, flowScope.credential, flowScope.service,messageContext)"></evaluate>
        <transition on="error" to="initializeLoginForm" />
        <transition on="verifySign" to="verifySign" />
        <transition on="verificationCode" to="verificationCode" />
        <transition on="casBadAuthorityView" to="casBadAuthorityView" />
    </action-state>
    
     <action-state id="verificationCode">
    	<evaluate expression="authenticationViaFormKeyPinAction.verificationCode(flowRequestContext, flowScope.credential, messageContext)"></evaluate>
        <transition on="error" to="initializeLoginForm" />
        <transition on="success" to="realSubmit" />
    </action-state>
         
    <!--add by wlw, add  verifySign for  verify-->
    <action-state id="verifySign">
        <evaluate expression="authenticationViaFormKeyPinAction.verifySign(flowRequestContext, flowScope.credential, messageContext)"></evaluate>
        <transition on="error" to="initializeLoginForm" />
        <transition on="success" to="realSubmit" />
    </action-state>

    <action-state id="realSubmit">
        <evaluate expression="authenticationViaFormAction"/>
        <transition on="warn" to="warn"/>
        <transition on="success" to="createTicketGrantingTicket"/>
        <transition on="successWithWarnings" to="showAuthenticationWarningMessages"/>
        <transition on="authenticationFailure" to="handleAuthenticationFailure"/>
        <transition on="error" to="initializeLoginForm"/>
    </action-state>
    
    <end-state id="casBadAuthorityView" view="casBadAuthorityView"></end-state>

</flow>
